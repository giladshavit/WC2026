<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Results Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { opacity: 0.6; pointer-events: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button { background: #f3f4f6; color: #6b7280; }
        .tab-button.active { background: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Admin - Results Management</h1>
                
                <!-- Tab Navigation -->
                <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg">
                    <button 
                        onclick="switchTab('matches')" 
                        id="tab-matches"
                        class="tab-button active px-4 py-2 rounded-md font-medium transition-colors"
                    >
                        Match Results
                    </button>
                    <button 
                        onclick="switchTab('groups')" 
                        id="tab-groups"
                        class="tab-button px-4 py-2 rounded-md font-medium transition-colors"
                    >
                        Group Results
                    </button>
                    <button 
                        onclick="switchTab('third-place')" 
                        id="tab-third-place"
                        class="tab-button px-4 py-2 rounded-md font-medium transition-colors"
                    >
                        Third Place Results
                    </button>
                </div>

                <!-- Match Results Tab -->
                <div id="matches-tab" class="tab-content active">
                    <div id="matches-loading" class="text-center py-8">
                        <div class="text-xl">Loading matches...</div>
                    </div>
                    
                    <div id="matches-container" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Match ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stage</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Home Team</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Away Team</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Result</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="matches-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Matches will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="no-matches" class="hidden text-center py-8 text-gray-500">
                            No matches found with both teams defined.
                        </div>
                    </div>
                </div>

                <!-- Group Results Tab -->
                <div id="groups-tab" class="tab-content">
                    <div id="groups-loading" class="text-center py-8">
                        <div class="text-xl">Loading groups...</div>
                    </div>
                    
                    <div id="groups-container" class="hidden">
                        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                            <!-- Groups will be populated here -->
                        </div>
                        
                        <div id="no-groups" class="hidden text-center py-8 text-gray-500">
                            No groups found.
                        </div>
                    </div>
                </div>

                <!-- Third Place Results Tab -->
                <div id="third-place-tab" class="tab-content">
                    <div id="third-place-loading" class="text-center py-8">
                        <div class="text-xl">Loading third place results...</div>
                    </div>
                    
                    <div id="third-place-container" class="hidden">
                        <div class="mb-6">
                            <button 
                                onclick="editThirdPlaceResult()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                            >
                                Set Third Place Results
                            </button>
                            <p class="text-sm text-gray-600 mt-2">
                                Note: Only teams that finished in 3rd place from group stage results are available for selection.
                            </p>
                        </div>
                        
                        <div id="third-place-result-display" class="hidden">
                            <h3 class="text-lg font-semibold mb-4">Current Third Place Qualifying Teams:</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">1st</div>
                                    <div id="third-place-1st" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">2nd</div>
                                    <div id="third-place-2nd" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">3rd</div>
                                    <div id="third-place-3rd" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">4th</div>
                                    <div id="third-place-4th" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">5th</div>
                                    <div id="third-place-5th" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">6th</div>
                                    <div id="third-place-6th" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">7th</div>
                                    <div id="third-place-7th" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">8th</div>
                                    <div id="third-place-8th" class="text-sm text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="no-third-place-result" class="hidden text-center py-8 text-gray-500">
                            No third place results set yet.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let matches = [];
        let groups = [];
        let thirdPlaceResult = null;
        let editingMatchId = null;
        let editingGroupId = null;

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to selected button
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Load data for the selected tab
            if (tabName === 'matches' && matches.length === 0) {
                fetchMatches();
            } else if (tabName === 'groups' && groups.length === 0) {
                fetchGroups();
            } else if (tabName === 'third-place') {
                fetchThirdPlaceResults();
            }
        }

        // Fetch matches from API
        async function fetchMatches() {
            try {
                const response = await fetch('/api/admin/matches/results');
                if (response.ok) {
                    matches = await response.json();
                    renderMatches();
                } else {
                    console.error('Failed to fetch matches');
                    showError('matches', 'Failed to fetch matches');
                }
            } catch (error) {
                console.error('Error fetching matches:', error);
                showError('matches', 'Error fetching matches');
            }
        }

        // Fetch groups from API
        async function fetchGroups() {
            try {
                const response = await fetch('/api/admin/groups/results');
                if (response.ok) {
                    groups = await response.json();
                    // Always try to render - function will handle if tab is not active
                    renderGroups();
                } else {
                    console.error('Failed to fetch groups');
                    showError('groups', 'Failed to fetch groups');
                }
            } catch (error) {
                console.error('Error fetching groups:', error);
                showError('groups', 'Error fetching groups');
            }
        }

        // Render matches in the table
        function renderMatches() {
            const tbody = document.getElementById('matches-tbody');
            const noMatches = document.getElementById('no-matches');
            const loading = document.getElementById('matches-loading');
            const container = document.getElementById('matches-container');

            // Safety check - make sure elements exist
            if (!tbody || !noMatches || !loading || !container) {
                console.error('Required DOM elements not found for renderMatches');
                return;
            }

            loading.classList.add('hidden');
            container.classList.remove('hidden');

            if (matches.length === 0) {
                noMatches.classList.remove('hidden');
                return;
            }

            noMatches.classList.add('hidden');
            tbody.innerHTML = '';

            matches.forEach(match => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${match.match_id}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${getStageDisplayName(match.stage)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(match.date)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${match.home_team.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${match.away_team.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="font-medium">
                            ${match.result.home_team_score !== null && match.result.away_team_score !== null
                                ? `${match.result.home_team_score} - ${match.result.away_team_score}`
                                : 'No result'
                            }
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                        <button
                            onclick="editMatch(${match.match_id})"
                            class="text-blue-600 hover:text-blue-900 bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded"
                        >
                            Edit
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Render groups
        function renderGroups() {
            try {
                const container = document.getElementById('groups-container');
                const noGroups = document.getElementById('no-groups');
                const loading = document.getElementById('groups-loading');

                // Safety check - make sure elements exist
                if (!container || !noGroups || !loading) {
                    console.warn('Groups tab not active - skipping render');
                    return;
                }

            loading.classList.add('hidden');
            container.classList.remove('hidden');

            if (groups.length === 0) {
                noGroups.classList.remove('hidden');
                return;
            }

            noGroups.classList.add('hidden');
            container.innerHTML = '';

            groups.forEach(group => {
                const groupCard = document.createElement('div');
                groupCard.className = 'bg-white border border-gray-200 rounded-lg p-4';
                
                let teamsHtml = '';
                group.teams.forEach(team => {
                    teamsHtml += `<div class="text-sm text-gray-600">${team.name}</div>`;
                });

                let resultHtml = '';
                if (group.result) {
                    resultHtml = `
                        <div class="mt-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Current Result:</h4>
                            <div class="space-y-1">
                                <div class="flex justify-between text-sm">
                                    <span>1st:</span>
                                    <span class="font-medium">${getTeamNameById(group.result.first_place, group.teams)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>2nd:</span>
                                    <span class="font-medium">${getTeamNameById(group.result.second_place, group.teams)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>3rd:</span>
                                    <span class="font-medium">${getTeamNameById(group.result.third_place, group.teams)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>4th:</span>
                                    <span class="font-medium">${getTeamNameById(group.result.fourth_place, group.teams)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultHtml = '<div class="mt-4 text-sm text-gray-500">No result set</div>';
                }

                groupCard.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Group ${group.group_name}</h3>
                    <div class="mb-3">
                        <h4 class="font-semibold text-gray-700 mb-1">Teams:</h4>
                        ${teamsHtml}
                    </div>
                    ${resultHtml}
                    <button
                        onclick="editGroup(${group.group_id})"
                        class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                    >
                        ${group.result ? 'Edit Result' : 'Set Result'}
                    </button>
                `;
                
                container.appendChild(groupCard);
            });
            } catch (error) {
                console.warn('Error rendering groups:', error);
            }
        }

        // Edit match function (existing code)
        function editMatch(matchId) {
            const match = matches.find(m => m.match_id === matchId);
            if (!match) return;

            editingMatchId = matchId;
            
            const editForm = document.createElement('div');
            editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            editForm.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h2 class="text-xl font-bold mb-4">Edit Match Result</h2>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">${match.home_team.name} vs ${match.away_team.name}</p>
                    </div>
                    <div class="flex items-center space-x-4 mb-6">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">${match.home_team.name}</label>
                            <input type="number" min="0" id="home-score" value="${match.result.home_team_score || ''}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                        </div>
                        <div class="text-2xl font-bold text-gray-500">-</div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">${match.away_team.name}</label>
                            <input type="number" min="0" id="away-score" value="${match.result.away_team_score || ''}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="saveMatchResult(${matchId})" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save</button>
                        <button onclick="cancelEdit()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editForm);
        }

        // Edit group function
        function editGroup(groupId) {
            const group = groups.find(g => g.group_id === groupId);
            if (!group) return;

            editingGroupId = groupId;
            
            const editForm = document.createElement('div');
            editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            editForm.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h2 class="text-xl font-bold mb-4">Set Group ${group.group_name} Result</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">1st Place</label>
                            <select id="first-place" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select team</option>
                                ${group.teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">2nd Place</label>
                            <select id="second-place" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select team</option>
                                ${group.teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">3rd Place</label>
                            <select id="third-place" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select team</option>
                                ${group.teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">4th Place</label>
                            <select id="fourth-place" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select team</option>
                                ${group.teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button onclick="saveGroupResult(${groupId})" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save</button>
                        <button onclick="cancelEdit()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editForm);
            
            // Pre-fill existing values if result exists (after adding to DOM)
            if (group.result) {
                document.getElementById('first-place').value = group.result.first_place;
                document.getElementById('second-place').value = group.result.second_place;
                document.getElementById('third-place').value = group.result.third_place;
                document.getElementById('fourth-place').value = group.result.fourth_place;
            }
        }

        // Save match result
        async function saveMatchResult(matchId) {
            const homeScore = parseInt(document.getElementById('home-score').value);
            const awayScore = parseInt(document.getElementById('away-score').value);

            if (isNaN(homeScore) || isNaN(awayScore) || homeScore < 0 || awayScore < 0) {
                alert('Please enter valid non-negative scores');
                return;
            }

            try {
                const response = await fetch(`/api/admin/matches/${matchId}/result`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        home_team_score: homeScore,
                        away_team_score: awayScore
                    }),
                });

                if (response.ok) {
                    await fetchMatches();
                    cancelEdit();
                    alert('Match result updated successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.detail}`);
                }
            } catch (error) {
                console.error('Error updating result:', error);
                alert('Error updating result');
            }
        }

        // Save group result
        async function saveGroupResult(groupId) {
            const firstPlace = parseInt(document.getElementById('first-place').value);
            const secondPlace = parseInt(document.getElementById('second-place').value);
            const thirdPlace = parseInt(document.getElementById('third-place').value);
            const fourthPlace = parseInt(document.getElementById('fourth-place').value);

            // Validate all selections
            if (!firstPlace || !secondPlace || !thirdPlace || !fourthPlace) {
                alert('Please select a team for all positions');
                return;
            }

            // Validate unique teams
            const teamIds = [firstPlace, secondPlace, thirdPlace, fourthPlace];
            if (new Set(teamIds).size !== 4) {
                alert('Each team must be selected only once');
                return;
            }

            try {
                const response = await fetch(`/api/admin/groups/${groupId}/result`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_place_team_id: firstPlace,
                        second_place_team_id: secondPlace,
                        third_place_team_id: thirdPlace,
                        fourth_place_team_id: fourthPlace
                    }),
                });

                if (response.ok) {
                    // Always refresh groups data
                    await fetchGroups();
                    cancelEdit();
                    alert('Group result updated successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.detail}`);
                }
            } catch (error) {
                console.error('Error updating group result:', error);
                alert('Error updating group result');
            }
        }

        // Cancel edit function
        function cancelEdit() {
            editingMatchId = null;
            editingGroupId = null;
            const editForm = document.querySelector('.fixed.inset-0');
            if (editForm) {
                editForm.remove();
            }
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'TBD';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getStageDisplayName(stage) {
            const stageMap = {
                'group': 'Group Stage', 'round32': 'Round of 32',
                'round16': 'Round of 16', 'quarter': 'Quarter Finals',
                'semi': 'Semi Finals', 'final': 'Final'
            };
            return stageMap[stage] || stage;
        }

        function getTeamNameById(teamId, teams) {
            const team = teams.find(t => t.id === teamId);
            return team ? team.name : 'Unknown';
        }

        function showError(tab, message) {
            const loading = document.getElementById(`${tab}-loading`);
            if (loading) {
                loading.innerHTML = `<div class="text-red-600">${message}</div>`;
            } else {
                console.error(`Error: ${message} (element ${tab}-loading not found)`);
            }
        }

        // Fetch third place results from API
        async function fetchThirdPlaceResults() {
            try {
                const response = await fetch('/api/admin/third-place/results');
                if (response.ok) {
                    const data = await response.json();
                    thirdPlaceResult = data;
                    renderThirdPlaceResults();
                } else {
                    console.error('Error fetching third place results:', response.statusText);
                    showError('third-place', 'Error loading third place results');
                }
            } catch (error) {
                console.error('Error fetching third place results:', error);
                showError('third-place', 'Error loading third place results');
            }
        }

        // Render third place results
        function renderThirdPlaceResults() {
            try {
                const loading = document.getElementById('third-place-loading');
                const container = document.getElementById('third-place-container');
                const resultDisplay = document.getElementById('third-place-result-display');
                const noResult = document.getElementById('no-third-place-result');

                if (!loading || !container || !resultDisplay || !noResult) {
                    console.warn('Required DOM elements not found for renderThirdPlaceResults');
                    return;
                }

                loading.classList.add('hidden');
                container.classList.remove('hidden');

                if (thirdPlaceResult && thirdPlaceResult.has_result) {
                    const result = thirdPlaceResult.result;
                    const eligibleTeams = thirdPlaceResult.eligible_teams || [];
                    
                    // Display current results
                    document.getElementById('third-place-1st').textContent = getTeamNameById(result.first_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-2nd').textContent = getTeamNameById(result.second_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-3rd').textContent = getTeamNameById(result.third_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-4th').textContent = getTeamNameById(result.fourth_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-5th').textContent = getTeamNameById(result.fifth_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-6th').textContent = getTeamNameById(result.sixth_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-7th').textContent = getTeamNameById(result.seventh_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-8th').textContent = getTeamNameById(result.eighth_team_qualifying, eligibleTeams);
                    
                    resultDisplay.classList.remove('hidden');
                    noResult.classList.add('hidden');
                } else {
                    resultDisplay.classList.add('hidden');
                    noResult.classList.remove('hidden');
                }
            } catch (error) {
                console.warn('Error rendering third place results:', error);
            }
        }

        // Edit third place result
        async function editThirdPlaceResult() {
            // Get both results and eligible teams in one request
            let teams = [];
            try {
                const response = await fetch('/api/admin/third-place/results');
                if (response.ok) {
                    const data = await response.json();
                    teams = data.eligible_teams || [];
                }
            } catch (error) {
                console.error('Error fetching third place data:', error);
                alert('Error loading third place data');
                return;
            }
            
            if (teams.length === 0) {
                alert('No teams available. Please set group stage results first.');
                return;
            }

            // Create modal form
            const editForm = document.createElement('div');
            editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            editForm.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">Set Third Place Qualifying Teams</h3>
                    
                    <form id="third-place-form">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            ${[1,2,3,4,5,6,7,8].map(pos => `
                                <div>
                                    <label class="block text-sm font-medium mb-2">${pos}${pos === 1 ? 'st' : pos === 2 ? 'nd' : pos === 3 ? 'rd' : 'th'} Place</label>
                                    <select id="third-place-${pos}" class="w-full p-2 border border-gray-300 rounded-md" required>
                                        <option value="">Select Team</option>
                                        ${teams.map(team => `<option value="${team.id}">${team.name} (Group ${team.group_name})</option>`).join('')}
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="cancelEdit()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Cancel
                            </button>
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                                Save Results
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(editForm);

            // Pre-fill existing values if result exists
            if (thirdPlaceResult && thirdPlaceResult.has_result) {
                const result = thirdPlaceResult.result;
                const positions = [
                    'first_team_qualifying', 'second_team_qualifying', 'third_team_qualifying', 'fourth_team_qualifying',
                    'fifth_team_qualifying', 'sixth_team_qualifying', 'seventh_team_qualifying', 'eighth_team_qualifying'
                ];
                
                positions.forEach((pos, index) => {
                    const select = document.getElementById(`third-place-${index + 1}`);
                    if (select && result[pos]) {
                        select.value = result[pos];
                    }
                });
            }

            // Handle form submission
            editForm.querySelector('#third-place-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const positions = [1,2,3,4,5,6,7,8];
                const teamIds = positions.map(pos => {
                    const select = document.getElementById(`third-place-${pos}`);
                    return parseInt(select.value);
                });

                // Validate that all teams are selected and different
                if (teamIds.some(id => !id)) {
                    alert('Please select all 8 teams');
                    return;
                }

                if (new Set(teamIds).size !== 8) {
                    alert('All 8 teams must be different');
                    return;
                }

                try {
                    const response = await fetch('/api/admin/third-place/results', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            first_team_qualifying: teamIds[0],
                            second_team_qualifying: teamIds[1],
                            third_team_qualifying: teamIds[2],
                            fourth_team_qualifying: teamIds[3],
                            fifth_team_qualifying: teamIds[4],
                            sixth_team_qualifying: teamIds[5],
                            seventh_team_qualifying: teamIds[6],
                            eighth_team_qualifying: teamIds[7]
                        }),
                    });

                    if (response.ok) {
                        await fetchThirdPlaceResults();
                        cancelEdit();
                        alert('Third place results updated successfully!');
                    } else {
                        const errorData = await response.json();
                        alert(`Error: ${errorData.detail}`);
                    }
                } catch (error) {
                    console.error('Error updating third place results:', error);
                    alert('Error updating third place results');
                }
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            fetchMatches();
        });
    </script>
</body>
</html>
