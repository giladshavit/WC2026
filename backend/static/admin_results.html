<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Match Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Admin - Match Results</h1>
                
                <div id="loading" class="text-center py-8">
                    <div class="text-xl">Loading matches...</div>
                </div>
                
                <div id="matches-container" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Match ID
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Stage
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Date
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Home Team
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Away Team
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Result
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="matches-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Matches will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="no-matches" class="hidden text-center py-8 text-gray-500">
                        No matches found with both teams defined.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let matches = [];
        let editingMatchId = null;

        // Fetch matches from API
        async function fetchMatches() {
            try {
                const response = await fetch('/api/admin/matches/results');
                if (response.ok) {
                    matches = await response.json();
                    renderMatches();
                } else {
                    console.error('Failed to fetch matches');
                    showError('Failed to fetch matches');
                }
            } catch (error) {
                console.error('Error fetching matches:', error);
                showError('Error fetching matches');
            }
        }

        // Render matches in the table
        function renderMatches() {
            const tbody = document.getElementById('matches-tbody');
            const noMatches = document.getElementById('no-matches');
            const loading = document.getElementById('loading');
            const container = document.getElementById('matches-container');

            loading.classList.add('hidden');
            container.classList.remove('hidden');

            if (matches.length === 0) {
                noMatches.classList.remove('hidden');
                return;
            }

            noMatches.classList.add('hidden');
            tbody.innerHTML = '';

            matches.forEach(match => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${match.match_id}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${getStageDisplayName(match.stage)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatDate(match.date)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${match.home_team.name}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${match.away_team.name}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="font-medium">
                            ${match.result.home_team_score !== null && match.result.away_team_score !== null
                                ? `${match.result.home_team_score} - ${match.result.away_team_score}`
                                : 'No result'
                            }
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                        <button
                            onclick="editMatch(${match.match_id})"
                            class="text-blue-600 hover:text-blue-900 bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded"
                        >
                            Edit
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit match function
        function editMatch(matchId) {
            const match = matches.find(m => m.match_id === matchId);
            if (!match) return;

            editingMatchId = matchId;
            
            // Create edit form
            const editForm = document.createElement('div');
            editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            editForm.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h2 class="text-xl font-bold mb-4">Edit Match Result</h2>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">
                            ${match.home_team.name} vs ${match.away_team.name}
                        </p>
                    </div>
                    <div class="flex items-center space-x-4 mb-6">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${match.home_team.name}
                            </label>
                            <input
                                type="number"
                                min="0"
                                id="home-score"
                                value="${match.result.home_team_score || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="0"
                            />
                        </div>
                        <div class="text-2xl font-bold text-gray-500">-</div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${match.away_team.name}
                            </label>
                            <input
                                type="number"
                                min="0"
                                id="away-score"
                                value="${match.result.away_team_score || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="0"
                            />
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button
                            onclick="saveResult(${matchId})"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
                        >
                            Save
                        </button>
                        <button
                            onclick="cancelEdit()"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editForm);
        }

        // Save result function
        async function saveResult(matchId) {
            const homeScore = parseInt(document.getElementById('home-score').value);
            const awayScore = parseInt(document.getElementById('away-score').value);

            if (isNaN(homeScore) || isNaN(awayScore) || homeScore < 0 || awayScore < 0) {
                alert('Please enter valid non-negative scores');
                return;
            }

            try {
                const response = await fetch(`/api/admin/matches/${matchId}/result`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        home_team_score: homeScore,
                        away_team_score: awayScore
                    }),
                });

                if (response.ok) {
                    // Refresh the matches list
                    await fetchMatches();
                    cancelEdit();
                    alert('Result updated successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.detail}`);
                }
            } catch (error) {
                console.error('Error updating result:', error);
                alert('Error updating result');
            }
        }

        // Cancel edit function
        function cancelEdit() {
            editingMatchId = null;
            const editForm = document.querySelector('.fixed.inset-0');
            if (editForm) {
                editForm.remove();
            }
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'TBD';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStageDisplayName(stage) {
            const stageMap = {
                'group': 'Group Stage',
                'round32': 'Round of 32',
                'round16': 'Round of 16',
                'quarter': 'Quarter Finals',
                'semi': 'Semi Finals',
                'final': 'Final'
            };
            return stageMap[stage] || stage;
        }

        function showError(message) {
            const loading = document.getElementById('loading');
            loading.innerHTML = `<div class="text-red-600">${message}</div>`;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            fetchMatches();
        });
    </script>
</body>
</html>
