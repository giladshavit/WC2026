<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Results Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { opacity: 0.6; pointer-events: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button { background: #f3f4f6; color: #6b7280; }
        .tab-button.active { background: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Admin - Results Management</h1>
                
                <!-- Navigation Buttons -->
                <div class="mb-6 flex space-x-4">
                    <a href="/knockout" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        üèÜ View Knockout Matches
                    </a>
                </div>
                
                <!-- Tab Navigation -->
                <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg">
                    <button 
                        onclick="switchTab('matches')" 
                        id="tab-matches"
                        class="tab-button active px-4 py-2 rounded-md font-medium transition-colors"
                    >
                        Match Results
                    </button>
                    <button 
                        onclick="switchTab('groups')" 
                        id="tab-groups"
                        class="tab-button px-4 py-2 rounded-md font-medium transition-colors"
                    >
                        Group Results
                    </button>
                    <button 
                        onclick="switchTab('third-place')" 
                        id="tab-third-place"
                        class="tab-button px-4 py-2 rounded-md font-medium transition-colors"
                    >
                        Third Place Results
                    </button>
                    <button 
                        onclick="switchTab('knockout')" 
                        id="tab-knockout"
                        class="tab-button px-4 py-2 rounded-md font-medium transition-colors"
                    >
                        Knockout Matches
                    </button>
                    <button 
                        onclick="switchTab('stage-management')" 
                        id="tab-stage-management"
                        class="tab-button px-4 py-2 rounded-md font-medium transition-colors"
                    >
                        Stage Management
                    </button>
                </div>

                <!-- Match Results Tab -->
                <div id="matches-tab" class="tab-content active">
                    <div id="matches-loading" class="text-center py-8">
                        <div class="text-xl">Loading matches...</div>
                    </div>
                    
                    <div id="matches-container" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Match ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stage</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Home Team</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Away Team</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Result</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="matches-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Matches will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="no-matches" class="hidden text-center py-8 text-gray-500">
                            No matches found with both teams defined.
                        </div>
                    </div>
                </div>

                <!-- Group Results Tab -->
                <div id="groups-tab" class="tab-content">
                    <div id="groups-loading" class="text-center py-8">
                        <div class="text-xl">Loading groups...</div>
                    </div>
                    
                    <div id="groups-container" class="hidden">
                        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                            <!-- Groups will be populated here -->
                        </div>
                        
                        <div id="no-groups" class="hidden text-center py-8 text-gray-500">
                            No groups found.
                        </div>
                    </div>
                </div>

                <!-- Third Place Results Tab -->
                <div id="third-place-tab" class="tab-content">
                    <div id="third-place-loading" class="text-center py-8">
                        <div class="text-xl">Loading third place results...</div>
                    </div>
                    
                    <div id="third-place-container" class="hidden">
                        <div class="mb-6">
                            <button 
                                onclick="editThirdPlaceResult()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                            >
                                Set Third Place Results
                            </button>
                            <p class="text-sm text-gray-600 mt-2">
                                Note: Only teams that finished in 3rd place from group stage results are available for selection.
                            </p>
                        </div>
                        
                        <div id="third-place-result-display" class="hidden">
                            <h3 class="text-lg font-semibold mb-4">Current Third Place Qualifying Teams:</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">1st</div>
                                    <div id="third-place-1st" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">2nd</div>
                                    <div id="third-place-2nd" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">3rd</div>
                                    <div id="third-place-3rd" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">4th</div>
                                    <div id="third-place-4th" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">5th</div>
                                    <div id="third-place-5th" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">6th</div>
                                    <div id="third-place-6th" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">7th</div>
                                    <div id="third-place-7th" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-lg text-center">
                                    <div class="font-medium">8th</div>
                                    <div id="third-place-8th" class="text-sm text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="no-third-place-result" class="hidden text-center py-8 text-gray-500">
                            No third place results set yet.
                        </div>
                    </div>
                </div>

                <!-- Knockout Matches Tab -->
                <div id="knockout-tab" class="tab-content">
                    <div id="knockout-loading" class="text-center py-8">
                        <div class="text-xl">Loading knockout matches...</div>
                    </div>
                    
                    <div id="knockout-container" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Match ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stage</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Home Team</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Away Team</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Result</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="knockout-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Knockout matches will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stage Management Tab -->
                <div id="stage-management-tab" class="tab-content">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Tournament Stage Management</h2>
                        
                        <!-- Current Stage Info -->
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h3 class="text-lg font-semibold text-blue-800 mb-2">Current Tournament Stage</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Stage:</label>
                                    <div id="current-stage" class="text-lg font-bold text-blue-600">Loading...</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Stage Value:</label>
                                    <div id="current-stage-value" class="text-lg font-bold text-blue-600">Loading...</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Current Penalty:</label>
                                    <div id="current-penalty" class="text-lg font-bold text-blue-600">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Stage Controls -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Stage Controls</h3>
                            <div class="flex flex-wrap gap-4">
                                <button 
                                    onclick="advanceStage()" 
                                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors"
                                >
                                    ‚û°Ô∏è Advance to Next Stage
                                </button>
                                <button 
                                    onclick="resetStage()" 
                                    class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded transition-colors"
                                >
                                    üîÑ Reset to Beginning
                                </button>
                            </div>
                        </div>

                        <!-- Stage Selection -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Set Specific Stage</h3>
                            <div class="flex flex-wrap gap-2">
                                <select id="stage-select" class="border border-gray-300 rounded-md px-3 py-2">
                                    <option value="PRE_GROUP_STAGE">Pre Group Stage</option>
                                    <option value="GROUP_CYCLE_1">Group Cycle 1</option>
                                    <option value="GROUP_CYCLE_2">Group Cycle 2</option>
                                    <option value="GROUP_CYCLE_3">Group Cycle 3</option>
                                    <option value="PRE_ROUND32">Pre Round 32</option>
                                    <option value="ROUND32">Round 32</option>
                                    <option value="PRE_ROUND16">Pre Round 16</option>
                                    <option value="ROUND16">Round 16</option>
                                    <option value="PRE_QUARTER">Pre Quarter</option>
                                    <option value="QUARTER">Quarter</option>
                                    <option value="SEMI">Semi</option>
                                    <option value="FINAL">Final</option>
                                </select>
                                <button 
                                    onclick="setSpecificStage()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors"
                                >
                                    Set Stage
                                </button>
                            </div>
                        </div>

                        <!-- Stage Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Stage Information</h3>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><strong>Pre Group Stage:</strong> All predictions editable (penalty: 0)</p>
                                <p><strong>Group Cycle 1-2:</strong> All predictions editable (penalty: 1-2)</p>
                                <p><strong>Group Cycle 3:</strong> Blocks group & third place predictions (penalty: 3)</p>
                                <p><strong>Round 32:</strong> Blocks round32 knockout predictions (penalty: 5)</p>
                                <p><strong>Round 16:</strong> Blocks round16 knockout predictions (penalty: 7)</p>
                                <p><strong>Quarter:</strong> Blocks quarter knockout predictions (penalty: 9)</p>
                                <p><strong>Semi:</strong> Blocks semi knockout predictions (penalty: 10)</p>
                                <p><strong>Final:</strong> Blocks final knockout predictions (penalty: 11)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let matches = [];
        let groups = [];
        let thirdPlaceResult = null;
        let knockoutMatches = [];
        let editingMatchId = null;
        let editingGroupId = null;

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to selected button
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Load data for the selected tab
            if (tabName === 'matches' && matches.length === 0) {
                fetchMatches();
            } else if (tabName === 'groups' && groups.length === 0) {
                fetchGroups();
            } else if (tabName === 'third-place') {
                fetchThirdPlaceResults();
            } else if (tabName === 'knockout') {
                fetchKnockoutMatches();
            } else if (tabName === 'stage-management') {
                loadStageInfo();
            }
        }

        // Fetch matches from API
        async function fetchMatches() {
            try {
                const response = await fetch('/api/admin/matches/results');
                if (response.ok) {
                    matches = await response.json();
                    renderMatches();
                } else {
                    console.error('Failed to fetch matches');
                    showError('matches', 'Failed to fetch matches');
                }
            } catch (error) {
                console.error('Error fetching matches:', error);
                showError('matches', 'Error fetching matches');
            }
        }

        // Fetch groups from API
        async function fetchGroups() {
            try {
                const response = await fetch('/api/admin/groups/results');
                if (response.ok) {
                    groups = await response.json();
                    // Always try to render - function will handle if tab is not active
                    renderGroups();
                } else {
                    console.error('Failed to fetch groups');
                    showError('groups', 'Failed to fetch groups');
                }
            } catch (error) {
                console.error('Error fetching groups:', error);
                showError('groups', 'Error fetching groups');
            }
        }

        // Render matches in the table
        function renderMatches() {
            const tbody = document.getElementById('matches-tbody');
            const noMatches = document.getElementById('no-matches');
            const loading = document.getElementById('matches-loading');
            const container = document.getElementById('matches-container');

            // Safety check - make sure elements exist
            if (!tbody || !noMatches || !loading || !container) {
                console.error('Required DOM elements not found for renderMatches');
                return;
            }

            loading.classList.add('hidden');
            container.classList.remove('hidden');

            if (matches.length === 0) {
                noMatches.classList.remove('hidden');
                return;
            }

            noMatches.classList.add('hidden');
            tbody.innerHTML = '';

            matches.forEach(match => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${match.match_id}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${getStageDisplayName(match.stage)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(match.date)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${match.home_team.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${match.away_team.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="font-medium">
                            ${match.result.home_team_score !== null && match.result.away_team_score !== null
                                ? `${match.result.home_team_score} - ${match.result.away_team_score}`
                                : 'No result'
                            }
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(match.status)}">
                            ${getStatusDisplayName(match.status)}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button
                                onclick="editMatch(${match.match_id})"
                                class="text-blue-600 hover:text-blue-900 bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded"
                            >
                                Edit
                            </button>
                            <button
                                onclick="editMatchStatus(${match.match_id}, '${match.status}')"
                                class="text-green-600 hover:text-green-900 bg-green-100 hover:bg-green-200 px-3 py-1 rounded"
                            >
                                Status
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Render groups
        function renderGroups() {
            try {
                const container = document.getElementById('groups-container');
                const noGroups = document.getElementById('no-groups');
                const loading = document.getElementById('groups-loading');

                // Safety check - make sure elements exist
                if (!container || !noGroups || !loading) {
                    console.warn('Groups tab not active - skipping render');
                    return;
                }

            loading.classList.add('hidden');
            container.classList.remove('hidden');

            if (groups.length === 0) {
                noGroups.classList.remove('hidden');
                return;
            }

            noGroups.classList.add('hidden');
            container.innerHTML = '';

            groups.forEach(group => {
                const groupCard = document.createElement('div');
                groupCard.className = 'bg-white border border-gray-200 rounded-lg p-4';
                
                let teamsHtml = '';
                group.teams.forEach(team => {
                    teamsHtml += `<div class="text-sm text-gray-600">${team.name}</div>`;
                });

                let resultHtml = '';
                if (group.result) {
                    resultHtml = `
                        <div class="mt-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Current Result:</h4>
                            <div class="space-y-1">
                                <div class="flex justify-between text-sm">
                                    <span>1st:</span>
                                    <span class="font-medium">${getTeamNameById(group.result.first_place, group.teams)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>2nd:</span>
                                    <span class="font-medium">${getTeamNameById(group.result.second_place, group.teams)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>3rd:</span>
                                    <span class="font-medium">${getTeamNameById(group.result.third_place, group.teams)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>4th:</span>
                                    <span class="font-medium">${getTeamNameById(group.result.fourth_place, group.teams)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultHtml = '<div class="mt-4 text-sm text-gray-500">No result set</div>';
                }

                groupCard.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Group ${group.group_name}</h3>
                    <div class="mb-3">
                        <h4 class="font-semibold text-gray-700 mb-1">Teams:</h4>
                        ${teamsHtml}
                    </div>
                    ${resultHtml}
                    <button
                        onclick="editGroup(${group.group_id})"
                        class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                    >
                        ${group.result ? 'Edit Result' : 'Set Result'}
                    </button>
                `;
                
                container.appendChild(groupCard);
            });
            } catch (error) {
                console.warn('Error rendering groups:', error);
            }
        }

        // Edit match function (existing code)
        function editMatch(matchId) {
            const match = matches.find(m => m.match_id === matchId);
            if (!match) return;

            editingMatchId = matchId;
            
            // Check if this is a knockout match
            const isKnockout = match.stage && ['round32', 'round16', 'quarter', 'semi', 'final'].includes(match.stage);
            
            const editForm = document.createElement('div');
            editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // Build the form content based on match type
            let formContent = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h2 class="text-xl font-bold mb-4">Edit Match Result</h2>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">${match.home_team.name} vs ${match.away_team.name}</p>
                        ${isKnockout ? '<p class="text-xs text-blue-600 mb-2">Knockout Match - Extra time and penalties available</p>' : ''}
                    </div>
                    
                    <!-- 90 Minutes Score -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-blue-600">90 Minutes</h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.home_team.name}</label>
                                <input type="number" min="0" id="home-score-90" value="${match.result.home_team_score || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                            </div>
                            <div class="text-2xl font-bold text-gray-500">-</div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.away_team.name}</label>
                                <input type="number" min="0" id="away-score-90" value="${match.result.away_team_score || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                            </div>
                        </div>
                    </div>`;
            
            // Add extra time and penalties only for knockout matches
            if (isKnockout) {
                formContent += `
                    <!-- Extra Time Score (Optional) -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-orange-600">Extra Time (Optional)</h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.home_team.name}</label>
                                <input type="number" min="0" id="home-score-120" value="${match.result.home_team_score_120 || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="0" />
                            </div>
                            <div class="text-2xl font-bold text-gray-500">-</div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.away_team.name}</label>
                                <input type="number" min="0" id="away-score-120" value="${match.result.away_team_score_120 || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="0" />
                            </div>
                        </div>
                    </div>

                    <!-- Penalties (Optional) -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-red-600">Penalties (Optional)</h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.home_team.name}</label>
                                <input type="number" min="0" id="home-penalties" value="${match.result.home_team_penalties || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="0" />
                            </div>
                            <div class="text-2xl font-bold text-gray-500">-</div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.away_team.name}</label>
                                <input type="number" min="0" id="away-penalties" value="${match.result.away_team_penalties || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="0" />
                            </div>
                        </div>
                    </div>`;
            }
            
            formContent += `
                    <div class="flex space-x-3">
                        <button onclick="saveMatchResult(${matchId})" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save</button>
                        <button onclick="cancelEdit()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    </div>
                </div>`;
            
            editForm.innerHTML = formContent;
            document.body.appendChild(editForm);
        }

        // Edit group function
        function editGroup(groupId) {
            const group = groups.find(g => g.group_id === groupId);
            if (!group) return;

            editingGroupId = groupId;
            
            const editForm = document.createElement('div');
            editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            editForm.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h2 class="text-xl font-bold mb-4">Set Group ${group.group_name} Result</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">1st Place</label>
                            <select id="first-place" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select team</option>
                                ${group.teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">2nd Place</label>
                            <select id="second-place" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select team</option>
                                ${group.teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">3rd Place</label>
                            <select id="third-place" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select team</option>
                                ${group.teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">4th Place</label>
                            <select id="fourth-place" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select team</option>
                                ${group.teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button onclick="saveGroupResult(${groupId})" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save</button>
                        <button onclick="cancelEdit()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editForm);
            
            // Pre-fill existing values if result exists (after adding to DOM)
            if (group.result) {
                document.getElementById('first-place').value = group.result.first_place;
                document.getElementById('second-place').value = group.result.second_place;
                document.getElementById('third-place').value = group.result.third_place;
                document.getElementById('fourth-place').value = group.result.fourth_place;
            }
        }

        // Save match result
        async function saveMatchResult(matchId) {
            const match = matches.find(m => m.match_id === matchId);
            const isKnockout = match.stage && ['round32', 'round16', 'quarter', 'semi', 'final'].includes(match.stage);
            
            const homeScore90 = parseInt(document.getElementById('home-score-90').value);
            const awayScore90 = parseInt(document.getElementById('away-score-90').value);

            if (isNaN(homeScore90) || isNaN(awayScore90) || homeScore90 < 0 || awayScore90 < 0) {
                alert('Please enter valid non-negative scores for 90 minutes');
                return;
            }

            // Build request body
            let requestBody = {
                home_team_score: homeScore90,
                away_team_score: awayScore90,
                outcome_type: 'regular'
            };

            // Add knockout-specific fields only if this is a knockout match
            if (isKnockout) {
                const homeScore120 = parseInt(document.getElementById('home-score-120').value) || null;
                const awayScore120 = parseInt(document.getElementById('away-score-120').value) || null;
                const homePenalties = parseInt(document.getElementById('home-penalties').value) || null;
                const awayPenalties = parseInt(document.getElementById('away-penalties').value) || null;

                requestBody.home_team_score_120 = homeScore120;
                requestBody.away_team_score_120 = awayScore120;
                requestBody.home_team_penalties = homePenalties;
                requestBody.away_team_penalties = awayPenalties;

                // Determine outcome type
                if (homePenalties !== null && awayPenalties !== null) {
                    requestBody.outcome_type = 'penalties';
                } else if (homeScore120 !== null && awayScore120 !== null) {
                    requestBody.outcome_type = 'extra_time';
                }
            }

            try {
                const response = await fetch(`/api/admin/matches/${matchId}/result`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (response.ok) {
                    await fetchMatches();
                    cancelEdit();
                    alert('Match result updated successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.detail}`);
                }
            } catch (error) {
                console.error('Error updating result:', error);
                alert('Error updating result');
            }
        }

        // Save group result
        async function saveGroupResult(groupId) {
            const firstPlace = parseInt(document.getElementById('first-place').value);
            const secondPlace = parseInt(document.getElementById('second-place').value);
            const thirdPlace = parseInt(document.getElementById('third-place').value);
            const fourthPlace = parseInt(document.getElementById('fourth-place').value);

            // Validate all selections
            if (!firstPlace || !secondPlace || !thirdPlace || !fourthPlace) {
                alert('Please select a team for all positions');
                return;
            }

            // Validate unique teams
            const teamIds = [firstPlace, secondPlace, thirdPlace, fourthPlace];
            if (new Set(teamIds).size !== 4) {
                alert('Each team must be selected only once');
                return;
            }

            try {
                const response = await fetch(`/api/admin/groups/${groupId}/result`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_place_team_id: firstPlace,
                        second_place_team_id: secondPlace,
                        third_place_team_id: thirdPlace,
                        fourth_place_team_id: fourthPlace
                    }),
                });

                if (response.ok) {
                    // Always refresh groups data
                    await fetchGroups();
                    cancelEdit();
                    alert('Group result updated successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.detail}`);
                }
            } catch (error) {
                console.error('Error updating group result:', error);
                alert('Error updating group result');
            }
        }

        // Cancel edit function
        function cancelEdit() {
            editingMatchId = null;
            editingGroupId = null;
            const editForm = document.querySelector('.fixed.inset-0');
            if (editForm) {
                editForm.remove();
            }
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'TBD';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getStageDisplayName(stage) {
            const stageMap = {
                'group': 'Group Stage', 'round32': 'Round of 32',
                'round16': 'Round of 16', 'quarter': 'Quarter Finals',
                'semi': 'Semi Finals', 'final': 'Final'
            };
            return stageMap[stage] || stage;
        }

        function getTeamNameById(teamId, teams) {
            const team = teams.find(t => t.id === teamId);
            return team ? team.name : 'Unknown';
        }

        function showError(tab, message) {
            const loading = document.getElementById(`${tab}-loading`);
            if (loading) {
                loading.innerHTML = `<div class="text-red-600">${message}</div>`;
            } else {
                console.error(`Error: ${message} (element ${tab}-loading not found)`);
            }
        }

        // Fetch third place results from API
        async function fetchThirdPlaceResults() {
            try {
                const response = await fetch('/api/admin/third-place/results');
                if (response.ok) {
                    const data = await response.json();
                    thirdPlaceResult = data;
                    renderThirdPlaceResults();
                } else {
                    console.error('Error fetching third place results:', response.statusText);
                    showError('third-place', 'Error loading third place results');
                }
            } catch (error) {
                console.error('Error fetching third place results:', error);
                showError('third-place', 'Error loading third place results');
            }
        }

        // Fetch knockout matches from API
        async function fetchKnockoutMatches() {
            try {
                const response = await fetch('/api/admin/knockout/results');
                if (response.ok) {
                    const data = await response.json();
                    knockoutMatches = data;
                    renderKnockoutMatches(data);
                } else {
                    console.error('Failed to fetch knockout matches');
                }
            } catch (error) {
                console.error('Error fetching knockout matches:', error);
            }
        }

        // Render third place results
        function renderThirdPlaceResults() {
            try {
                const loading = document.getElementById('third-place-loading');
                const container = document.getElementById('third-place-container');
                const resultDisplay = document.getElementById('third-place-result-display');
                const noResult = document.getElementById('no-third-place-result');

                if (!loading || !container || !resultDisplay || !noResult) {
                    console.warn('Required DOM elements not found for renderThirdPlaceResults');
                    return;
                }

                loading.classList.add('hidden');
                container.classList.remove('hidden');

                if (thirdPlaceResult && thirdPlaceResult.has_result) {
                    const result = thirdPlaceResult.result;
                    const eligibleTeams = thirdPlaceResult.eligible_teams || [];
                    
                    // Display current results
                    document.getElementById('third-place-1st').textContent = getTeamNameById(result.first_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-2nd').textContent = getTeamNameById(result.second_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-3rd').textContent = getTeamNameById(result.third_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-4th').textContent = getTeamNameById(result.fourth_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-5th').textContent = getTeamNameById(result.fifth_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-6th').textContent = getTeamNameById(result.sixth_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-7th').textContent = getTeamNameById(result.seventh_team_qualifying, eligibleTeams);
                    document.getElementById('third-place-8th').textContent = getTeamNameById(result.eighth_team_qualifying, eligibleTeams);
                    
                    resultDisplay.classList.remove('hidden');
                    noResult.classList.add('hidden');
                } else {
                    resultDisplay.classList.add('hidden');
                    noResult.classList.remove('hidden');
                }
            } catch (error) {
                console.warn('Error rendering third place results:', error);
            }
        }

        // Render knockout matches
        function renderKnockoutMatches(matches) {
            try {
                const loading = document.getElementById('knockout-loading');
                const container = document.getElementById('knockout-container');
                const tbody = document.getElementById('knockout-tbody');
                
                if (!loading || !container || !tbody) {
                    console.error('Required DOM elements not found for renderKnockoutMatches');
                    return;
                }
                
                loading.classList.add('hidden');
                container.classList.remove('hidden');
                
                tbody.innerHTML = '';
                
                if (matches.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-3 text-center text-gray-500">No knockout matches found</td></tr>';
                    return;
                }
                
                matches.forEach(match => {
                    const row = document.createElement('tr');
                    
                    // Get stage name
                    const stageNames = {
                        'round32': '32 ◊î◊í◊ì◊ï◊ú◊ï◊™',
                        'round16': '16 ◊î◊í◊ì◊ï◊ú◊ï◊™', 
                        'quarter': '◊®◊ë◊¢ ◊í◊û◊®',
                        'semi': '◊ó◊¶◊ô ◊í◊û◊®',
                        'final': '◊í◊û◊®'
                    };
                    
                    // Format result
                    let resultText = 'No result';
                    if (match.has_result && match.match_result) {
                        const result = match.match_result;
                        resultText = `${result.home_team_score} - ${result.away_team_score}`;
                        
                        if (result.outcome_type === 'extra_time' && result.home_team_score_120 !== null) {
                            resultText += ` (${result.home_team_score_120} - ${result.away_team_score_120} ET)`;
                        } else if (result.outcome_type === 'penalties' && result.home_team_penalties !== null) {
                            resultText += ` (${result.home_team_penalties} - ${result.away_team_penalties} PEN)`;
                        }
                        
                        if (result.winner_team_id) {
                            const winnerName = result.winner_team_id === match.home_team.id ? 
                                match.home_team.name : match.away_team.name;
                            resultText += ` - Winner: ${winnerName}`;
                        }
                    }
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900">${match.match_id}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${stageNames[match.stage] || match.stage}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${match.date ? new Date(match.date).toLocaleDateString('he-IL') : 'TBD'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${match.home_team.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${match.away_team.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${resultText}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(match.status)}">
                                ${getStatusDisplayName(match.status)}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            <div class="flex space-x-2">
                                <button 
                                    onclick="editKnockoutMatch(${match.match_id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm"
                                >
                                    ${match.has_result ? 'Edit Result' : 'Set Result'}
                                </button>
                                <button
                                    onclick="editMatchStatus(${match.match_id}, '${match.status}')"
                                    class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm"
                                >
                                    Status
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.warn('Error rendering knockout matches:', error);
            }
        }

        // Edit knockout match result
        function editKnockoutMatch(matchId) {
            const match = knockoutMatches.find(m => m.match_id === matchId);
            if (!match) return;

            editingMatchId = matchId;
            
            // Check if this is a knockout match (it always is in this context)
            const isKnockout = true; // All matches in knockout tab are knockout matches
            
            const editForm = document.createElement('div');
            editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // Build the form content
            let formContent = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h2 class="text-xl font-bold mb-4">Edit Knockout Match Result</h2>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">${match.home_team.name} vs ${match.away_team.name}</p>
                        <p class="text-xs text-blue-600 mb-2">Knockout Match - Extra time and penalties available</p>
                    </div>
                    
                    <!-- 90 Minutes Score -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-blue-600">90 Minutes</h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.home_team.name}</label>
                                <input type="number" min="0" id="home-score-90" value="${match.match_result?.home_team_score || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                            </div>
                            <div class="text-2xl font-bold text-gray-500">-</div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.away_team.name}</label>
                                <input type="number" min="0" id="away-score-90" value="${match.match_result?.away_team_score || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                            </div>
                        </div>
                    </div>

                    <!-- Extra Time Score (Optional) -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-orange-600">Extra Time (Optional)</h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.home_team.name}</label>
                                <input type="number" min="0" id="home-score-120" value="${match.match_result?.home_team_score_120 || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="0" />
                            </div>
                            <div class="text-2xl font-bold text-gray-500">-</div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.away_team.name}</label>
                                <input type="number" min="0" id="away-score-120" value="${match.match_result?.away_team_score_120 || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="0" />
                            </div>
                        </div>
                    </div>

                    <!-- Penalties (Optional) -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-red-600">Penalties (Optional)</h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.home_team.name}</label>
                                <input type="number" min="0" id="home-penalties" value="${match.match_result?.home_team_penalties || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="0" />
                            </div>
                            <div class="text-2xl font-bold text-gray-500">-</div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">${match.away_team.name}</label>
                                <input type="number" min="0" id="away-penalties" value="${match.match_result?.away_team_penalties || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="0" />
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="saveKnockoutMatchResult(${matchId})" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save</button>
                        <button onclick="cancelEdit()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    </div>
                </div>`;
            
            editForm.innerHTML = formContent;
            document.body.appendChild(editForm);
        }

        // Save knockout match result
        async function saveKnockoutMatchResult(matchId) {
            const match = knockoutMatches.find(m => m.match_id === matchId);
            
            const homeScore90 = parseInt(document.getElementById('home-score-90').value);
            const awayScore90 = parseInt(document.getElementById('away-score-90').value);

            if (isNaN(homeScore90) || isNaN(awayScore90) || homeScore90 < 0 || awayScore90 < 0) {
                alert('Please enter valid non-negative scores for 90 minutes');
                return;
            }

            // Build request body with knockout-specific fields
            const homeScore120 = parseInt(document.getElementById('home-score-120').value) || null;
            const awayScore120 = parseInt(document.getElementById('away-score-120').value) || null;
            const homePenalties = parseInt(document.getElementById('home-penalties').value) || null;
            const awayPenalties = parseInt(document.getElementById('away-penalties').value) || null;

            let requestBody = {
                home_team_score: homeScore90,
                away_team_score: awayScore90,
                home_team_score_120: homeScore120,
                away_team_score_120: awayScore120,
                home_team_penalties: homePenalties,
                away_team_penalties: awayPenalties,
                outcome_type: 'regular'
            };

            // Determine outcome type
            if (homePenalties !== null && awayPenalties !== null) {
                requestBody.outcome_type = 'penalties';
            } else if (homeScore120 !== null && awayScore120 !== null) {
                requestBody.outcome_type = 'extra_time';
            }

            try {
                const response = await fetch(`/api/admin/matches/${matchId}/result`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (response.ok) {
                    await fetchKnockoutMatches(); // Refresh the knockout matches
                    cancelEdit();
                    alert('Knockout match result updated successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.detail}`);
                }
            } catch (error) {
                console.error('Error saving knockout match result:', error);
                alert('Error saving result');
            }
        }

        // Edit third place result
        async function editThirdPlaceResult() {
            // Get both results and eligible teams in one request
            let teams = [];
            try {
                const response = await fetch('/api/admin/third-place/results');
                if (response.ok) {
                    const data = await response.json();
                    teams = data.eligible_teams || [];
                }
            } catch (error) {
                console.error('Error fetching third place data:', error);
                alert('Error loading third place data');
                return;
            }
            
            if (teams.length === 0) {
                alert('No teams available. Please set group stage results first.');
                return;
            }

            // Create modal form
            const editForm = document.createElement('div');
            editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            editForm.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">Set Third Place Qualifying Teams</h3>
                    
                    <form id="third-place-form">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            ${[1,2,3,4,5,6,7,8].map(pos => `
                                <div>
                                    <label class="block text-sm font-medium mb-2">${pos}${pos === 1 ? 'st' : pos === 2 ? 'nd' : pos === 3 ? 'rd' : 'th'} Place</label>
                                    <select id="third-place-${pos}" class="w-full p-2 border border-gray-300 rounded-md" required>
                                        <option value="">Select Team</option>
                                        ${teams.map(team => `<option value="${team.id}">${team.name} (Group ${team.group_name})</option>`).join('')}
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="cancelEdit()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Cancel
                            </button>
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                                Save Results
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(editForm);

            // Pre-fill existing values if result exists
            if (thirdPlaceResult && thirdPlaceResult.has_result) {
                const result = thirdPlaceResult.result;
                const positions = [
                    'first_team_qualifying', 'second_team_qualifying', 'third_team_qualifying', 'fourth_team_qualifying',
                    'fifth_team_qualifying', 'sixth_team_qualifying', 'seventh_team_qualifying', 'eighth_team_qualifying'
                ];
                
                positions.forEach((pos, index) => {
                    const select = document.getElementById(`third-place-${index + 1}`);
                    if (select && result[pos]) {
                        select.value = result[pos];
                    }
                });
            }

            // Handle form submission
            editForm.querySelector('#third-place-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const positions = [1,2,3,4,5,6,7,8];
                const teamIds = positions.map(pos => {
                    const select = document.getElementById(`third-place-${pos}`);
                    return parseInt(select.value);
                });

                // Validate that all teams are selected and different
                if (teamIds.some(id => !id)) {
                    alert('Please select all 8 teams');
                    return;
                }

                if (new Set(teamIds).size !== 8) {
                    alert('All 8 teams must be different');
                    return;
                }

                try {
                    const response = await fetch('/api/admin/third-place/results', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            first_team_qualifying: teamIds[0],
                            second_team_qualifying: teamIds[1],
                            third_team_qualifying: teamIds[2],
                            fourth_team_qualifying: teamIds[3],
                            fifth_team_qualifying: teamIds[4],
                            sixth_team_qualifying: teamIds[5],
                            seventh_team_qualifying: teamIds[6],
                            eighth_team_qualifying: teamIds[7]
                        }),
                    });

                    if (response.ok) {
                        await fetchThirdPlaceResults();
                        cancelEdit();
                        alert('Third place results updated successfully!');
                    } else {
                        const errorData = await response.json();
                        alert(`Error: ${errorData.detail}`);
                    }
                } catch (error) {
                    console.error('Error updating third place results:', error);
                    alert('Error updating third place results');
                }
            });
        }

        // Stage Management Functions
        async function loadStageInfo() {
            try {
                const response = await fetch('/api/admin/stage/current');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('current-stage').textContent = data.stage;
                    document.getElementById('current-stage-value').textContent = data.stage_value;
                    document.getElementById('current-penalty').textContent = data.penalty;
                } else {
                    console.error('Error loading stage info:', response.statusText);
                }
            } catch (error) {
                console.error('Error loading stage info:', error);
            }
        }

        async function advanceStage() {
            if (confirm('Are you sure you want to advance to the next tournament stage?')) {
                try {
                    const response = await fetch('/api/admin/stage/advance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        alert(`Stage advanced to ${data.stage}`);
                        loadStageInfo();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.detail || 'Failed to advance stage'}`);
                    }
                } catch (error) {
                    console.error('Error advancing stage:', error);
                    alert('Error advancing stage');
                }
            }
        }

        async function resetStage() {
            if (confirm('Are you sure you want to reset the tournament stage to the beginning? This will make all predictions editable again.')) {
                try {
                    const response = await fetch('/api/admin/stage/reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        alert('Tournament stage reset to beginning');
                        loadStageInfo();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.detail || 'Failed to reset stage'}`);
                    }
                } catch (error) {
                    console.error('Error resetting stage:', error);
                    alert('Error resetting stage');
                }
            }
        }

        async function setSpecificStage() {
            const selectedStage = document.getElementById('stage-select').value;
            
            if (confirm(`Are you sure you want to set the tournament stage to ${selectedStage}?`)) {
                try {
                    const response = await fetch('/api/admin/stage/update', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ stage: selectedStage })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        alert(`Stage updated to ${data.stage}`);
                        loadStageInfo();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.detail || 'Failed to update stage'}`);
                    }
                } catch (error) {
                    console.error('Error updating stage:', error);
                    alert('Error updating stage');
                }
            }
        }

        // Get status display name
        function getStatusDisplayName(status) {
            const statusMap = {
                'scheduled': 'Scheduled',
                'live_editable': 'Live (Editable)',
                'live_locked': 'Live (Locked)',
                'finished': 'Finished'
            };
            return statusMap[status] || status;
        }

        // Get status color class
        function getStatusColor(status) {
            const colorMap = {
                'scheduled': 'bg-gray-100 text-gray-800',
                'live_editable': 'bg-yellow-100 text-yellow-800',
                'live_locked': 'bg-orange-100 text-orange-800',
                'finished': 'bg-green-100 text-green-800'
            };
            return colorMap[status] || 'bg-gray-100 text-gray-800';
        }

        // Edit match status
        function editMatchStatus(matchId, currentStatus) {
            const statusModal = document.createElement('div');
            statusModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const statusOptions = [
                { value: 'scheduled', label: 'Scheduled' },
                { value: 'live_editable', label: 'Live (Editable)' },
                { value: 'live_locked', label: 'Live (Locked)' },
                { value: 'finished', label: 'Finished' }
            ];
            
            let optionsHtml = '';
            statusOptions.forEach(option => {
                const selected = option.value === currentStatus ? 'selected' : '';
                optionsHtml += `<option value="${option.value}" ${selected}>${option.label}</option>`;
            });
            
            statusModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h2 class="text-xl font-bold mb-4">Update Match Status</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Match ID: ${matchId}</label>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Status: ${getStatusDisplayName(currentStatus)}</label>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Status:</label>
                        <select id="new-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${optionsHtml}
                        </select>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="saveMatchStatus(${matchId})" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save</button>
                        <button onclick="cancelStatusEdit()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(statusModal);
        }

        // Save match status
        async function saveMatchStatus(matchId) {
            const newStatus = document.getElementById('new-status').value;
            
            try {
                const response = await fetch(`/api/admin/matches/${matchId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Match status updated to ${getStatusDisplayName(newStatus)}`);
                    cancelStatusEdit();
                    fetchMatches(); // Refresh the matches
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Failed to update match status'}`);
                }
            } catch (error) {
                console.error('Error updating match status:', error);
                alert('Error updating match status');
            }
        }

        // Cancel status edit
        function cancelStatusEdit() {
            const statusModal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (statusModal) {
                statusModal.remove();
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            fetchMatches();
            loadStageInfo();
        });
    </script>
</body>
</html>
